-- Follow-up: Which segment had the most increase in unique products in
-- 2021 vs 2020? The final output contains these fields,
-- segment
-- product_count_2020
-- product_count_2021
-- difference

with unique_products_segment as
(
select
p.segment,s.fiscal_year,count(distinct product_code) as unique_products

from dim_product p
join fact_sales_monthly s
using (product_code)
where fiscal_year in (2020,2021)
group by p.segment,s.fiscal_year
)
select
segment,
max(case when fiscal_year=2020 then unique_products end) as product_count_2020,
    max(case when fiscal_year=2021 then unique_products end) as product_count_2021,
    
    max(case when fiscal_year=2021 then unique_products end)
    -
    max(case when fiscal_year=2020 then unique_products end)
        as product_difference,

   round((max(case when fiscal_year=2021 then unique_products end)-

    max(case when fiscal_year=2020 then unique_products end))*100/

   max(case when fiscal_year=2020 then unique_products end),2) as pct_change


from unique_products_segment
group by segment
order by pct_change desc

